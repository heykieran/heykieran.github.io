<!DOCTYPE html><html lang="en-us" >

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Kieran Owens">

  
  
  
    
  
  <meta name="description" content="I will demonstrate how to compile and package a completely operational, but minimal, application comprising a secure Clojure Pedestal API server and a ClojureScript (reagent/reframe) front-end React application; and finally deploy that application to a docker container running as a Docker swarm service with its configuration provided by Docker&#39;s secrets functionality.">

  
  <link rel="alternate" hreflang="en-us" href="https://heykieran.github.io/post/deploy-pedestal-react-to-docker/">

  


  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  <script src="/js/mathjax-config.js"></script>
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css" integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-light">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-dark" disabled>
      
    

    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  





<script async src="https://www.googletagmanager.com/gtag/js?id=UA-153619296-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-153619296-3', {});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  


  
  

  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu4daeebf65b4de862d319721e891ef302_24365_32x32_fill_lanczos_center_3.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu4daeebf65b4de862d319721e891ef302_24365_192x192_fill_lanczos_center_3.png">

  <link rel="canonical" href="https://heykieran.github.io/post/deploy-pedestal-react-to-docker/">

  
  
  
  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="twitter:site" content="@TimpsonGray">
  <meta property="twitter:creator" content="@TimpsonGray">
  
  <meta property="og:site_name" content="heykieran Code Notes">
  <meta property="og:url" content="https://heykieran.github.io/post/deploy-pedestal-react-to-docker/">
  <meta property="og:title" content="Deploy a Clojure Pedestal API Server &amp; React/ClojureScript Web Application to Docker | heykieran Code Notes">
  <meta property="og:description" content="I will demonstrate how to compile and package a completely operational, but minimal, application comprising a secure Clojure Pedestal API server and a ClojureScript (reagent/reframe) front-end React application; and finally deploy that application to a docker container running as a Docker swarm service with its configuration provided by Docker&#39;s secrets functionality."><meta property="og:image" content="https://heykieran.github.io/images/logo_hu40a566661c85156769430146dbdc8595_41816_300x300_fit_lanczos_3.png">
  <meta property="twitter:image" content="https://heykieran.github.io/images/logo_hu40a566661c85156769430146dbdc8595_41816_300x300_fit_lanczos_3.png"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2020-05-07T12:10:26-04:00">
    
    <meta property="article:modified_time" content="2020-06-21T13:25:42-04:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://heykieran.github.io/post/deploy-pedestal-react-to-docker/"
  },
  "headline": "Deploy a Clojure Pedestal API Server \u0026 React/ClojureScript Web Application to Docker",
  
  "datePublished": "2020-05-07T12:10:26-04:00",
  "dateModified": "2020-06-21T13:25:42-04:00",
  
  "author": {
    "@type": "Person",
    "name": "Kieran Owens"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "Timpson Gray",
    "logo": {
      "@type": "ImageObject",
      "url": "https://heykieran.github.io/images/logo_hu40a566661c85156769430146dbdc8595_41816_192x192_fit_lanczos_3.png"
    }
  },
  "description": "I will demonstrate how to compile and package a completely operational, but minimal, application comprising a secure Clojure Pedestal API server and a ClojureScript (reagent/reframe) front-end React application; and finally deploy that application to a docker container running as a Docker swarm service with its configuration provided by Docker's secrets functionality."
}
</script>

  

  


  


  





  <title>Deploy a Clojure Pedestal API Server &amp; React/ClojureScript Web Application to Docker | heykieran Code Notes</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  






  


<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/"><img src="/images/logo_hu40a566661c85156769430146dbdc8595_41816_0x70_resize_lanczos_3.png" alt="heykieran Code Notes"></a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/"><img src="/images/logo_hu40a566661c85156769430146dbdc8595_41816_0x70_resize_lanczos_3.png" alt="heykieran Code Notes"></a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link  active" href="/"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/author/kieran-owens"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      
      <li class="nav-item dropdown theme-dropdown">
        <a href="#" class="nav-link js-theme-selector" data-toggle="dropdown" aria-haspopup="true">
          <i class="fas fa-palette" aria-hidden="true"></i>
        </a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item js-set-theme-light">
            <span>Light</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-dark">
            <span>Dark</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-auto">
            <span>Automatic</span>
          </a>
        </div>
      </li>
      

      

    </ul>

  </div>
</nav>


  <article class="article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1>Deploy a Clojure Pedestal API Server &amp; React/ClojureScript Web Application to Docker</h1>

  
  <p class="page-subtitle">Now that you have your Pedestal API Server and Reagent/Reframe ClojureScript application working, how can you compile it, package it and deploy it securely to Docker?</p>
  

  
    


<div class="article-metadata">

  
  
  
  
  <div>
    

  
  <span><a href="/author/kieran-owens/">Kieran Owens</a></span>
  </div>
  
  

  
  <span class="article-date">
    
    
      
          Last updated on
      
    
    Jun 21, 2020
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    15 min read
  </span>
  

  
  
  
  <span class="middot-divider"></span>
  <a href="/post/deploy-pedestal-react-to-docker/#disqus_thread"></a>
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/blog-post/">Blog Post</a></span>
  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style">
      <h2 id="introduction">Introduction</h2>
<p>In this post I&rsquo;ll show how to build and deploy to docker a fully-functioning application comprising a secure Pedestal API web-server and a React front-end application written in ClojureScript which accesses the server.</p>
<p>For this example I&rsquo;ll be using the Pedestal/React application I previously discussed in this 
<a href="https://heykieran.github.io/post/pedestal-and-google/" target="_blank" rel="noopener">blog post</a> (with its code 
<a href="https://github.com/heykieran/clj-pedestal-spa/tree/v1.0" target="_blank" rel="noopener">here</a> for <strong>tag v1.0</strong>), and the code discussed in this post is available 
<a href="https://github.com/heykieran/clj-docker-deploy-ext" target="_blank" rel="noopener">here</a>.</p>
<h2 id="outline-of-the-steps">Outline of the Steps</h2>
<p>I&rsquo;ll set up a working directory for the build, clone the target application into a sub-directory, compile the target, package it and its dependencies to java byte code, assemble them into a jar, create a docker image for the application, and deploy it as a docker service.</p>
<h3 id="background-challenges--tools">Background, Challenges &amp; Tools</h3>
<p>During this exercise, I&rsquo;ll try to keep separate the application I&rsquo;m building from the application doing the building. This isn&rsquo;t strictly necessary but it will help illustrate a procedure generally applicable to any Clojure application.</p>
<p>One of the challenges of this approach is that I&rsquo;ll need to deal with two <code>deps.edn</code> files - one for the build environment and one for the application being built. Each <code>deps</code> file contains relative paths (<code>:paths</code> and <code>:extra-paths</code>) relative to the root of the project directory to which it belongs.</p>
<p>If I am to avoid changing in any way the <code>deps</code> file for the project being built and yet still ensure that the built artifacts end up in the correct location within the build project&rsquo;s directory structure I will need a way to inform the compiler about which paths to use, but relative to the <strong>build</strong> project&rsquo;s directory and not as specified in the <strong>target&rsquo;s</strong> <code>deps.edn</code> file.</p>
<p>As an example, let&rsquo;s suppose that the build project is at <code>./clj-deploy-docker</code> and the project being built will be cloned into <code>./clj-deploy-docker/target-app</code>.</p>
<p>The <code>deps.edn</code> file in <code>./clj-deploy-docker/target-app</code> will contain an entry for the alias <code>:main</code> as below</p>
<pre><code class="language-edn">:aliases
 {:main
  {:paths [&quot;src&quot;]
   :extra-deps {ch.qos.logback/logback-classic {:mvn/version &quot;1.2.3&quot;}
                org.clojure/tools.logging {:mvn/version &quot;0.4.1&quot;}
                ring/ring-core {:mvn/version &quot;1.8.0&quot;}
                ring/ring-jetty-adapter {:mvn/version &quot;1.8.0&quot;}
                ring/ring-devel {:mvn/version &quot;1.8.0&quot;}
                io.pedestal/pedestal.service {:mvn/version &quot;0.5.7&quot;}
                io.pedestal/pedestal.route {:mvn/version &quot;0.5.7&quot;}
                io.pedestal/pedestal.jetty {:mvn/version &quot;0.5.7&quot;}
                buddy {:mvn/version &quot;2.0.0&quot;}
                hiccup {:mvn/version &quot;1.0.5&quot;}
                org.conscrypt/conscrypt-openjdk-uber {:mvn/version &quot;2.2.1&quot;}
                org.eclipse.jetty/jetty-alpn-conscrypt-server {:mvn/version &quot;9.4.24.v20191120&quot;}
                com.google.api-client/google-api-client {:mvn/version &quot;1.30.6&quot;}
                com.walmartlabs/dyn-edn 
                {:git/url &quot;https://github.com/walmartlabs/dyn-edn.git&quot; 
                 :sha &quot;855a775959cf1bec531a303a323e6f05f7b260fb&quot;}}
   :extra-paths [&quot;resources&quot; &quot;common-src&quot; ]}
</code></pre>
<p>In order to access and use this alias correctly from the build project&rsquo;s directory (<code>clj-deploy-docker</code>) I will need to adjust (<em>in some way</em>) the paths so that the compiler is operating with the correct class path i.e. the class path of the target rather than the class path of the build. Therefore, I&rsquo;ll need to let the compiler know (<em>in some way</em>) that the <code>:paths</code> and <code>:extra-paths</code> vectors should read</p>
<pre><code>:paths [&quot;target-app/src&quot;]
</code></pre>
<p>and</p>
<pre><code>:extra-paths [&quot;target-app/resources&quot; &quot;target-app/common-src&quot; ]
</code></pre>
<p>respectively.</p>
<blockquote>
<p>On the other hand, the maven coordinates in the target&rsquo;s <code>deps.edn</code> file are correct, so we can leave the <code>:deps</code> and <code>:extra-deps</code> values as they are found.</p>
</blockquote>
<p>As for the <em>&ldquo;in some way&rdquo;</em>, I will be using the 
<a href="https://github.com/EwenG/badigeon" target="_blank" rel="noopener">Badigeon</a> library to achieve this. Many of Badigeon&rsquo;s API&rsquo;s take a <code>:deps-map</code> as input. This is an <em>in-memory</em> map whose structure is the same as a <code>deps.edn</code> file. This will allow me to read the <code>deps</code> file, make in-memory adjustments and feed it to to API to do the <em>bundling</em> and <em>compiling</em> with a classpath relative to any directory I choose (i.e. relative to <code>./clj-deploy-docker</code>).</p>
<h3 id="create-a-working-directory-for-the-project">Create a Working Directory for the Project</h3>
<p>Create a working directory for the project, and <code>cd</code> into it</p>
<pre><code>$ mkdir clj-deploy-docker
$ cd clj-deploy-docker
</code></pre>
<h3 id="setting-up-the-application-to-be-built">Setting up the Application to be built</h3>
<p>Now, I&rsquo;ll clone the repository of the application I want to build into a directory <code>target-app</code> under my working directory.</p>
<pre><code>$ git clone https://github.com/heykieran/clj-pedestal-google.git target-app
</code></pre>
<p>As mentioned above, for this exercise I will be using a library called 
<a href="https://github.com/EwenG/badigeon" target="_blank" rel="noopener">Badigeon</a> to organize and compile the sources. It leverages many of the tools &amp; libraries already available in <code>clojure.core</code> and <code>tools.deps</code>; it&rsquo;s very flexible and I find the API intuitive.</p>
<h3 id="creating-the-build-runner">Creating the build runner</h3>
<p>In my project&rsquo;s working directory I create a <code>deps.edn</code> file.</p>
<pre><code>$ touch deps.edn
</code></pre>
<p>and add the Badigeon dependency to the <code>deps.edn</code> file.</p>
<pre><code class="language-edn">{:deps 
  {}
  :aliases
  {:build
  {:extra-paths [&quot;build&quot;]
   :extra-deps
   {badigeon/badigeon
    {:git/url &quot;https://github.com/EwenG/badigeon.git&quot;
     :sha &quot;1edf7ae465db870ec0066f28226edb9b04873b70&quot;
     :tag &quot;0.0.11&quot;}}}}}
</code></pre>
<p>Apart from the Clojure system and user dependencies this is the only dependency I&rsquo;ll need in that file.</p>
<p>Also, for later use, I create a directory called <code>build</code> to contain the Clojure files to run the bundling, compilation and assembling processes.</p>
<pre><code>$ mkdir build
</code></pre>
<h3 id="building-the-front-end-js-file">Building the Front-End JS File</h3>
<p>As outlined in my previous 
<a href="https://heykieran.github.io/post/pedestal-and-google/" target="_blank" rel="noopener">blog post</a>, the following command will build the front-end production application&rsquo;s <code>js</code> file from the ClojureScript sources for the application being <em>dockerized</em>.</p>
<pre><code>$ cd target-app
$ clj -A:prod
$ cd ..
</code></pre>
<p>This will build the application&rsquo;s front-end only and place the production <code>js</code> file (<code>prod-main.js</code>) in the <code>target-app/target/public/cljs-out</code> directory. This is the <strong>only</strong> change that will be made to the directories and files under <code>target-app</code>.</p>
<p>At a later stage I will move this file to its correct location under my project directory (<code>./clj-deploy-docker</code>) so that it can be included in the docker image.</p>
<h3 id="building-the-back-end-jvm-class-files">Building the Back-End (JVM) Class Files</h3>
<p>I&rsquo;ll now <code>cd</code> into the <code>build</code> directory I created previously and create a <code>package.clj</code> file. This file will contain the <code>-main</code> method that ultimately performs the bundling, compilation and consolidation of the back-end Clojure files i.e. the JVM class files.</p>
<h4 id="some-background-on-bundling-compilation-and-consolidation-_jaring_">Some Background on Bundling, Compilation and Consolidation (<em><strong>Jar</strong>&lsquo;ing</em>)</h4>
<p>There are three distinct phases to assembling the JVM artifacts to include in the docker image and I will be using the Badigeon API to perform all three phases.</p>
<ol>
<li>
<h5 id="bundling">Bundling</h5>
<p>The <em>bundling</em> step creates a &ldquo;bundle&rdquo; at a specified file-system location of all the target project&rsquo;s resources and dependencies, including any <code>jar</code> files that are needed. Note that because the Badigeon bundler does not merge in the system and user <code>deps</code> preferences, it will not automatically copy sources that are in <code>src</code> directory of your project, <strong>unless</strong> that directory is explicitly specified in the <code>:paths</code> or <code>:extra-paths</code> entries in the <code>deps.edn</code> file. During the bundling phase all the <code>jar</code> files required by your application, and all other resources on the classpath such as static html file, css files, user authored js files etc. will be copied to the specified target directory.</p>
</li>
<li>
<h5 id="compilation">Compilation</h5>
<p>During the <em>compilation</em> step the compiled versions of your Clojure source files (as <code>.class</code> files) are generated and copied to a specified target directory.</p>
</li>
<li>
<h5 id="consolidation">Consolidation</h5>
<p>The final phase involves creating a <code>jar</code> file containing all the <code>.class</code> files needed by the application with an appropriate manifest file (<code>META-INF/MANIFEST.MF</code>) which has an entry indicating the application&rsquo;s entry-point (a <code>Main-Class</code> entry), and an entry specifying the libraries to be used by the <code>jar</code> file (a <code>Class-Path</code> entry).</p>
<blockquote>
<p>Dependencies (found by Badigeon using the <code>:deps</code> and <code>:extra-deps</code> coordinates) will <strong>not</strong> be incorporated into this <code>jar</code> file. They will however be added to a <code>./lib</code> directory as individual <code>jar</code> files and referenced by the <code>Class-Path</code> entry in the jar&rsquo;s manifest file.</p>
</blockquote>
</li>
</ol>
<p>Once these three phases are complete, <strong>and</strong> the js file containing the front-end application is placed in its correct location, the application can be run using the <code>java</code> command line tool.</p>
<p>I&rsquo;ll come to that presently, but first I&rsquo;d like to take a slightly deeper look at the <em>bundling</em>, <em>compilation</em> and <em>consolidation</em> phases. The full details are available in the <code>package.clj</code> file from which the following code snippets have been extracted.</p>
<h4 id="notes-on-the-code-performing-the-three-steps">Notes on the code performing the three steps</h4>
<p>First, I <strong>bundle</strong></p>
<pre><code class="language-clojure">(bundle
     out-path
     {:deps-map translated-deps-map
      :aliases aliases
      :libs-path &quot;lib&quot;})
</code></pre>
<p>Given a <code>deps-map</code> and a vector of aliases (<code>[:main]</code>) this function will copy the projects&rsquo;s resources needed to <code>out-path</code>, and also copy the <code>jar</code> files required to <code>out-path/lib</code>. Because the code I want to bundle is in the <code>target-app</code> directory, I&rsquo;ll read the <code>deps.edn</code> file from its location under <code>target-app</code> and update the <code>:path</code> and <code>:extra-paths</code> entries so that they are now relative to the current working directory rather than <code>target-app</code> (see 
<a href="#background-challenges--tools">above</a>).</p>
<p>Now the <strong>compilation</strong> phase runs:</p>
<pre><code class="language-clojure">(compile/compile
     'main.core
     {:compile-path
      classes-path
      :classpath
      (translate-path-to-absolute
       target-dir
       deps-map
       aliases)})
</code></pre>
<p>This compiles the <code>main.core</code> namespace, putting the <code>.class</code> files into the directory specified by the <code>classes-path</code> directory, using a classpath specified by the value of the <code>:classpath</code> entry. In my case, this is generated by reading the <code>target-app/deps.edn</code> file into <code>deps-map</code> and converting the relative components of <code>:paths</code> and <code>:extra-paths</code> vectors to absolute file-system locations.</p>
<p>Finally, the <strong>consolidation</strong> phase runs:</p>
<pre><code class="language-clojure">(spit manifest-path
          (jar/make-manifest
           'main.core
           {:Class-Path
            (str
             &quot;. &quot;
             (str/join
              &quot; &quot;
              (mapv
               #(str &quot;lib/&quot; (.getName %))
               (.listFiles (io/file &quot;target/app/lib&quot;)))))}))
    
    (zip/zip
     classes-path
     (str (make-path out-path &quot;app-runner&quot;) &quot;.jar&quot;))
</code></pre>
<p>This achieves two things:</p>
<ol>
<li>
<p>It creates a manifest file in <code>target/app/classes/META-INF</code>, setting <code>main.core</code> as the entry point, and adds entries for all the <code>jar</code> files in the <code>target/lib</code> directory (which was created and populated during <em>bundling</em>) into the manifest file&rsquo;s <code>Class-Path</code> header field. In order for the application to run there is an assumption that the final <code>jar</code> file and the <code>lib</code> directory will exist at the same level in the file system i.e. in the same directory.</p>
</li>
<li>
<p>It creates a <code>app-runner.jar</code> file from the contents of the <code>target/app/classes</code> directory. This <code>jar</code> file <strong>is</strong> the main application and will contain the manifest file just created with its <code>Class-Path</code> entry pointing to the non-application <code>jar</code> files it needs to run - i.e. those found in the <code>lib</code> directory.</p>
</li>
</ol>
<p>In order to run all three steps, I can &ldquo;execute&rdquo; the <code>package</code> namespace passing the <code>target-app</code> directory name as an argument.</p>
<pre><code>$ clj -A:build -m package &quot;target-app&quot;
</code></pre>
<p>This completes the Bundling, Compilation and Consolidation steps, and when it finishes I will have a directory structure, which with the addition of the front-end <code>js</code> file (which I compiled above) will constitute the complete application.</p>
<p>The result is a <code>target</code> folder containing an <code>app-runner.jar</code> file and any other supporting files needed to run the app. Many are extraneous; for instance all the classes files, now included in the <code>jar</code> file are also under this directory, as are the source code of the Clojure files.</p>
<p>I can copy the <code>js</code> file to its correct location using</p>
<pre><code>$ mkdir -p target/app/public/cljs-out &amp;&amp; \ 
  cp target-app/target/public/cljs-out/prod-main.js &quot;$_&quot;
</code></pre>
<p>Now, everything I need (and some I don&rsquo;t) is available in the <code>./target/app/</code> directory.</p>
<h4 id="running-the-application">Running the Application</h4>
<p>Before running the compiled application I need to ensure that certain environment variables are defined and set correctly.</p>
<p>As discussed in my 
<a href="https://heykieran.github.io/post/pedestal-and-google/" target="_blank" rel="noopener">previous post</a>, the application requires a number of environment variables to be set in order to configure itself correctly.</p>
<p>These are</p>
<pre><code># the https port number used by the Pedestal API server
ALLOC_SSL_PORT=8081 
# the password of Jetty's keystore 
ALLOC_KEYSTORE_PASSWORD=&lt;password&gt; 
# the http port number used by the Pedestal API server
ALLOC_PORT=8080 
# the file system location of the Jetty's keystore (as an absolute file path)
ALLOC_KEYSTORE_LOCATION=&lt;location&gt; 
</code></pre>
<p>I can <code>cd</code> into the built artifact&rsquo;s directory (<code>./target/app</code>) and run the backend application directly from the <code>jar</code> file</p>
<pre><code>$ cd target/app
$ java -jar app-runner.jar
</code></pre>
<p>or, because the classes still exist in a <code>classes</code> directory under the <code>app</code> directory</p>
<pre><code>$ cd target/app
$ java -cp .:classes:lib/* main.core
</code></pre>
<p>The app will start, and when it&rsquo;s fully initialized, I can navigate to 
<a href="https://localhost:8081/r/home" target="_blank" rel="noopener"><code>https://localhost:8081/r/home</code></a> to see it in action.</p>
<blockquote>
<p>There is also a lot of unnecessary &ldquo;residue&rdquo; in the <code>./target/app</code> directory, created during <em>bundling</em>, including directories containing clj and cljc files that are not actually needed to run the application (they will already have been compiled into the <code>classes</code> directory).</p>
</blockquote>
<p>When I process the files for deployment to docker, these will be removed.</p>
<p>There remains then only the task of creating the docker image itself, which is outlined below.</p>
<h2 id="quick-review">Quick Review</h2>
<p>Currently, we have in the <code>target/app</code> all the artifacts (with some extras) to run the application. Now we will rationalize those artifacts, removing all the unnecessary ones, leaving only those that are necessary for running our application and package what remains into a docker image, which we&rsquo;ll place in the folder <code>docker/deploy</code>.</p>
<h2 id="create-the-docker-image">Create the Docker Image</h2>
<p>The docker image I will use is very simple - a basic Debian stretch image with a Java8 SDK.</p>
<p>In my project directory I create a directory called <code>docker</code> and <code>cd</code> into it.</p>
<pre><code>$ mkdir docker
$ cd docker 
</code></pre>
<p>and create a <code>Dockerfile</code> containing</p>
<pre><code class="language-Dockerfile">FROM openjdk:8-stretch

COPY entrypoint.sh /sbin/entrypoint.sh
RUN chmod 755 /sbin/entrypoint.sh

EXPOSE 8081/tcp

COPY deploy /image

WORKDIR /image/app

ENV ALLOC_KEYSTORE_LOCATION=/image/local/jetty-keystore \
    ALLOC_KEYSTORE_PASSWORD=password \
    ALLOC_PORT=8080 \
    ALLOC_SSL_PORT=8081 

ENTRYPOINT [&quot;/sbin/entrypoint.sh&quot;]
</code></pre>
<p>The <code>Dockerfile</code> as defined will</p>
<ul>
<li>create an image from a base <code>openjdk:8-stretch</code> image,</li>
<li>copy the file <code>entrypoint.sh</code> (which I haven&rsquo;t created yet) from the <code>docker/deploy</code> folder to the image&rsquo;s <code>/sbin</code> directory and set its mode to executable,</li>
<li>enable network connectivity to port <code>8081</code> only (there will be <em>no</em> access to the unprotected <code>http</code> port 8080),</li>
<li>copy the entire contents of the <code>docker/deploy</code> directory to the image&rsquo;s <code>/image</code> directory,</li>
<li>set the image&rsquo;s working directory to <code>/image/app</code>,</li>
<li>set the needed environment variables for the new image, and</li>
<li>specify that the <code>/sbin/entrypoint.sh</code> script should be run when the container starts.</li>
</ul>
<p>The <code>deploy</code> directory under the <code>docker</code> directory is the location where the application&rsquo;s artifact will be assembled before their inclusion in the image when the <code>COPY deploy /image</code> command is run.</p>
<p>From my project&rsquo;s folder (<code>clj-deploy-docker</code>) I run the following command to copy the entire app (including residue) to the <code>docker/deploy</code> folder (creating it if it doesn&rsquo;t exist).</p>
<pre><code>$ mkdir -p docker/deploy/app &amp;&amp; cp -r target/app/* &quot;$_&quot;
</code></pre>
<p>Now, in order to remove the extraneous files I can run</p>
<pre><code>$ 	find docker/deploy/app -maxdepth 1 -mindepth 1 -type d \( ! \( -name 'lib' -o -name 'public' \) \) -exec rm -rf {} \;
</code></pre>
<p>This deletes any sub-directory in the <code>docker/deploy</code> folder <strong>not</strong> named <code>lib</code> (which contain the <code>jar</code> files the application needs) or <code>public</code> (which contains all the non-JVM resources the application needs).</p>
<p>I now add the <code>entrypoint.sh</code> file to the <code>docker</code> folder. This script, which is run when the image is started, simply calls the application&rsquo;s entry-point.</p>
<pre><code class="language-Shell">#!/bin/bash
# exit immediately if error
set -e

java -jar app-runner.jar
</code></pre>
<p>Finally, I need to ensure that the keystore used to encrypt the application&rsquo;s <code>https</code> communication is available for the image build process, so I copy it from my local file system&rsquo;s location to the <code>/docker/deploy/local</code> directory, from whence, during the image building process, it will be copied to the image&rsquo;s <code>/image/local</code> folder.</p>
<pre><code># mkdir -p docker/deploy/local &amp;&amp; cp &lt;location-of-keystore&gt; &quot;$_&quot;
</code></pre>
<p>Now, with everything cleaned-up and with the script and the keystore in place, I can create the application&rsquo;s docker image, tagging it with the label <code>testapp:dev</code>.</p>
<pre><code>$ docker build -t testapp:dev docker
</code></pre>
<p>and then run a container based on that image using</p>
<pre><code>$ docker run --rm --name test 
    --env ALLOC_KEYSTORE_PASSWORD=&lt;the-real-keystore-password&gt; 
    -p:8081:8081 
    -it testapp:dev
</code></pre>
<p>I can then open my browser to 
<a href="https://localhost:8081/r/home" target="_blank" rel="noopener"><code>https://localhost:8081/r/home</code></a> in order to confirm it&rsquo;s running correctly.</p>
<blockquote>
<p><strong>Note</strong>
When I created the image I did not include the correct password for the keystore in the Dockerfile. Therefore, in order for the application to work correctly I&rsquo;m required to pass the correct value by setting the env variable <code>ALLOC_KEYSTORE_PASSWORD</code> when I start the container. It will be used in lieu of the value embedded in the image.</p>
</blockquote>
<h2 id="docker-secrets">Docker Secrets</h2>
<p>Passing sensitive information using environment variables is satisfactory in many situations, but there is available a better approach: <strong>docker secrets</strong>.</p>
<blockquote>
<p><strong>Note</strong>
Docker secrets are <strong>not</strong> available in stand-alone mode, the feature is only available in <strong>swarm</strong> mode.</p>
</blockquote>
<h3 id="passing-configuration-values">Passing Configuration Values</h3>
<p>For further details on the subject of passing configurations to a Clojure application you can refer to my 
<a href="https://heykieran.github.io/post/clojure-configuration/" target="_blank" rel="noopener">blog post</a> on the subject. The post also discusses more fully the mechanics of how the configuration is used by the application&rsquo;s code.</p>
<h3 id="create-a-swarm">Create a swarm</h3>
<p>To create a local swarm for testing I can issue the following command</p>
<pre><code>$ docker swarm init
</code></pre>
<p>Once the swarm has been initialized I can add a secret to the registry. Let&rsquo;s suppose I want to protect the <code>ALLOC_KEYSTORE_PASSWORD</code> and avoid having to pass it to the image as an environment variable. I can simply create a docker secret to hold the value, protecting it from being stolen too easily. The following command will create a secret called <code>ALLOC_KEYSTORE_PASSWORD</code>, set its value to <code>MYKEYSTOREPASSWORD</code> and store it in the swarm&rsquo;s registry.</p>
<pre><code>$ printf &quot;MYKEYSTOREPASSWORD&quot; | docker secret create ALLOC_KEYSTORE_PASSWORD -
</code></pre>
<p>You can test that the secret was successfully created by issuing</p>
<pre><code>$ docker secret ls
</code></pre>
<p>In order to use the secret, the container has to be started as a service within the swarm, and on the command line must be specified to what secrets the service has access. In order to start the container with access to the <code>ALLOC_KEYSTORE_PASSWORD</code> and linking swarm&rsquo;s network to the host&rsquo;s network I can issue the following command</p>
<pre><code>$ docker service create --replicas 1 \
    --secret ALLOC_KEYSTORE_PASSWORD \ 
    --name testapp \
    --publish mode=host,published=8081,target=8081 \
    testapp:dev
</code></pre>
<p>This will start the service (named <code>testapp</code>) within the swarm, and the service will start serving the application similarly to when I used the <code>docker run</code> command above.</p>
<p>Once started the following command will return basic information about the service</p>
<pre><code>$ docker service ls
</code></pre>
<p>and this information should look something like the following</p>
<pre><code>ID                  NAME                MODE                REPLICAS            IMAGE               PORTS
kjzh1uc2ttng        testapp             replicated          1/1                 testapp:dev         
</code></pre>
<p>If I want to monitor the activity of the service I should monitor the <strong>logs</strong> of its associated container and, in order to do this I need to know the container&rsquo;s ID.</p>
<p>I can issue the following command and note the value in the <code>CONTAINER_ID</code> column for the image <code>testapp:dev</code> and use it to interrogate the logs.</p>
<pre><code>$ docker container ls
</code></pre>
<p>This will return something like the following:</p>
<pre><code class="language-Shell">CONTAINER ID        IMAGE               COMMAND                 CREATED             STATUS              PORTS                    NAMES
d5b269d508b4        testapp:dev         &quot;/sbin/entrypoint.sh&quot;   15 seconds ago      Up 14 seconds       0.0.0.0:8081-&gt;8081/tcp   testapp.1.tb4n70oe1t8tz3qdzo2aawmek
</code></pre>
<p>And I can view the logs of the running container using as much of the container&rsquo;s ID as necessary to make it unique</p>
<pre><code>$ docker logs d5b
</code></pre>
<p>This allows me to confirm that the application started correctly and is responding to requests.</p>
<p>As before, I can point my browser at 
<a href="https://localhost:8081/r/home" target="_blank" rel="noopener"><code>https://localhost:8081/r/home</code></a> and exercise the packaged application running as a docker service.</p>
<p>After some activity I can review the history of my interactions (and the server&rsquo;s responses) by once again reviewing the logs:</p>
<pre><code>$ docker logs d5
</code></pre>
<p>To shutdown the service, I run</p>
<pre><code>$ docker service rm testapp
</code></pre>
<h2 id="review">Review</h2>
<p>There were quite a number of steps but I hope the detail was illuminative.</p>
<p>A later post will illustrate how to integrate the build process within the Clojure application directory structure rather than requiring that it be cloned into a separate working directory.</p>
<p>That post will also show how the build and deployment steps can be automated using a simple Makefile.</p>

    </div>

    





  
  

<p class="edit-page">
  <a href="https://github.com/heykieran/timpson-gray-blog/edit/master/content/post%5cdeploy-pedestal-react-to-docker.md">
    <i class="fas fa-pen pr-2"></i>Edit this page
  </a>
</p>





<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/clojure/">clojure</a>
  
  <a class="badge badge-light" href="/tag/clojurescript/">clojurescript</a>
  
  <a class="badge badge-light" href="/tag/pedestal/">pedestal</a>
  
  <a class="badge badge-light" href="/tag/react/">react</a>
  
  <a class="badge badge-light" href="/tag/docker/">docker</a>
  
</div>














  
    
    





  
    
    
    
      
    
    
    
    <div class="media author-card content-widget-hr">
      
        
        <img class="avatar mr-3 avatar-circle" src="/author/kieran-owens/avatar_hu52a603635ecebd45650b162dadabb4e5_12861_270x270_fill_q90_lanczos_center.jpg" alt="Kieran Owens">
      

      <div class="media-body">
        <h5 class="card-title"><a href="https://heykieran.github.io/">Kieran Owens</a></h5>
        <h6 class="card-subtitle">CTO of Timpson Gray</h6>
        <p class="card-text">Experienced Technology Leader with a particular interest in the use of functional languages for building accounting systems.</p>
        <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/heykieran" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/heykieran" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
</ul>

      </div>
    </div>
  


  





<section id="comments">
  
    
<div id="disqus_thread"></div>
<script>
  let disqus_config = function () {
    
    
    
  };
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
      return;
    }
    var d = document, s = d.createElement('script'); s.async = true;
    s.src = 'https://' + "heykieran" + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  
</section>






  
  
  <div class="article-widget content-widget-hr">
    <h3>Related</h3>
    <ul>
      
      <li><a href="/post/pedestal-and-google/">Pedestal API, ClojureScript SPA and Google Authentication</a></li>
      
      <li><a href="/post/clojure-configuration/">Clojure Configurations with Docker Secrets</a></li>
      
      <li><a href="/post/pedestal-jetty-https/">Setting-up Pedestal/Jetty with HTTPS</a></li>
      
      <li><a href="/post/cadence-and-clojure/">Cadence Workflow and Clojure</a></li>
      
    </ul>
  </div>
  




  </div>
</article>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.8/mermaid.min.js" integrity="sha256-lyWCDMnMeZiXRi7Zl54sZGKYmgQs4izcT7+tKc+KUBk=" crossorigin="anonymous" title="mermaid"></script>
      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/clojure.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/shell.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/bash.min.js"></script>
        
      

    

    
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    <script>const isSiteThemeDark = false;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks",
        'slides' : "Slides"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    
    <script id="dsq-count-scr" src="https://heykieran.disqus.com/count.js" async></script>
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.38bcca7d01911f74920c35c1cca8a8ab.js"></script>

    






  
  
  <div class="container">
    <footer class="site-footer">
  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
       &middot; 
      <a href="/terms/">Terms</a>
    
  </p>
  

  <p class="powered-by">
    © Kieran J. Owens 2021
  </p>

  
  






  <p class="powered-by">
    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
