<!DOCTYPE html><html lang="en-us" >

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Kieran Owens">

  
  
  
    
  
  <meta name="description" content="A longer discussion of my publicly available GitHub repository containing a secured Pedestal API server and ClojureScript/React SPA that can use Google login to authenticate a user. I show how to set up HTTPS, integrate with Google and secure API endpoints in the context of a simple React application.">

  
  <link rel="alternate" hreflang="en-us" href="https://heykieran.github.io/post/pedestal-and-google/">

  


  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  <script src="/js/mathjax-config.js"></script>
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css" integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-light">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-dark" disabled>
      
    

    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  





<script async src="https://www.googletagmanager.com/gtag/js?id=UA-153619296-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-153619296-3', {});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  


  
  

  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu4daeebf65b4de862d319721e891ef302_24365_32x32_fill_lanczos_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu4daeebf65b4de862d319721e891ef302_24365_192x192_fill_lanczos_center_2.png">

  <link rel="canonical" href="https://heykieran.github.io/post/pedestal-and-google/">

  
  
  
  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="twitter:site" content="@TimpsonGray">
  <meta property="twitter:creator" content="@TimpsonGray">
  
  <meta property="og:site_name" content="heykieran Code Notes">
  <meta property="og:url" content="https://heykieran.github.io/post/pedestal-and-google/">
  <meta property="og:title" content="Pedestal API, ClojureScript SPA and Google Authentication | heykieran Code Notes">
  <meta property="og:description" content="A longer discussion of my publicly available GitHub repository containing a secured Pedestal API server and ClojureScript/React SPA that can use Google login to authenticate a user. I show how to set up HTTPS, integrate with Google and secure API endpoints in the context of a simple React application."><meta property="og:image" content="https://heykieran.github.io/images/logo_hu40a566661c85156769430146dbdc8595_41816_300x300_fit_lanczos_2.png">
  <meta property="twitter:image" content="https://heykieran.github.io/images/logo_hu40a566661c85156769430146dbdc8595_41816_300x300_fit_lanczos_2.png"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2020-04-27T11:53:08-04:00">
    
    <meta property="article:modified_time" content="2020-04-27T11:53:08-04:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://heykieran.github.io/post/pedestal-and-google/"
  },
  "headline": "Pedestal API, ClojureScript SPA and Google Authentication",
  
  "datePublished": "2020-04-27T11:53:08-04:00",
  "dateModified": "2020-04-27T11:53:08-04:00",
  
  "author": {
    "@type": "Person",
    "name": "Kieran Owens"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "Timpson Gray",
    "logo": {
      "@type": "ImageObject",
      "url": "https://heykieran.github.io/images/logo_hu40a566661c85156769430146dbdc8595_41816_192x192_fit_lanczos_2.png"
    }
  },
  "description": "A longer discussion of my publicly available GitHub repository containing a secured Pedestal API server and ClojureScript/React SPA that can use Google login to authenticate a user. I show how to set up HTTPS, integrate with Google and secure API endpoints in the context of a simple React application."
}
</script>

  

  


  


  





  <title>Pedestal API, ClojureScript SPA and Google Authentication | heykieran Code Notes</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  






  


<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/"><img src="/images/logo_hu40a566661c85156769430146dbdc8595_41816_0x70_resize_lanczos_2.png" alt="heykieran Code Notes"></a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/"><img src="/images/logo_hu40a566661c85156769430146dbdc8595_41816_0x70_resize_lanczos_2.png" alt="heykieran Code Notes"></a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link  active" href="/"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/author/kieran-owens"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      
      <li class="nav-item dropdown theme-dropdown">
        <a href="#" class="nav-link js-theme-selector" data-toggle="dropdown" aria-haspopup="true">
          <i class="fas fa-palette" aria-hidden="true"></i>
        </a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item js-set-theme-light">
            <span>Light</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-dark">
            <span>Dark</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-auto">
            <span>Automatic</span>
          </a>
        </div>
      </li>
      

      

    </ul>

  </div>
</nav>


  <article class="article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1>Pedestal API, ClojureScript SPA and Google Authentication</h1>

  
  <p class="page-subtitle">Securing a Pedestal served ClojureScript SPA using Google authentication.</p>
  

  
    


<div class="article-metadata">

  
  
  
  
  <div>
    

  
  <span><a href="/author/kieran-owens/">Kieran Owens</a></span>
  </div>
  
  

  
  <span class="article-date">
    
    
      
    
    Apr 27, 2020
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    12 min read
  </span>
  

  
  
  
  <span class="middot-divider"></span>
  <a href="/post/pedestal-and-google/#disqus_thread"></a>
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/blog-post/">Blog Post</a></span>
  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style">
      <h1 id="introduction">Introduction</h1>
<p>The following are some notes about a 
<a href="https://github.com/heykieran/clj-pedestal-spa/tree/v1.0" target="_blank" rel="noopener">repository</a>
containing working code (extracted from a larger project) demonstrating a
combination of a secured <strong>Pedestal</strong> website (and associated API services), and
a <strong>React</strong>-ive ClojureScript front-end application that utilizes either Google
or bespoke login logic to identify and validate the user&rsquo;s credentials, and sets
his/her authorization levels.</p>
<p>I hope that it may be helpful to anyone else who may know how each of the the
individual pieces work, but is wondering how to put it all together.</p>
<p>I owe a debt of gratitude to Tristan Straub, as much of the front-end logic (and
code) to utilize Google&rsquo;s login is based on some code he posted on

<a href="https://github.com/tristanstraub/cljs-google-signin" target="_blank" rel="noopener">Github</a>. I&rsquo;ve changed the
code in many ways, so any errors are not his but mine.</p>
<p>The front-end application, which is intentionally simple, allows a user to
login, and according to his/her permissions will allow access to various
resources. The application is written using React/ReFrame, Semantic UI React and
ClojureScript. The application uses Figwheel-main to compile and, in development
mode run the front-end; but switching to a different tool-chain (e.g.
shadow-cljs) should be relatively easy.</p>
<h1 id="features">Features</h1>
<h3 id="google-login-integration-and-mapping-to-application-id">Google Login Integration (and mapping to application id)</h3>
<p>The application demonstrates how to integrate Google&rsquo;s login
functionality with a ClojureScript application. After successfully
authenticating with Google, the user&rsquo;s Google <em>email</em> address is
associated with one (and only one) internal application user ID. The
internal user ID is associated internally with one or more application
defined roles, which are defined in the code.</p>
<p>Conceivably, this <em>mapping</em> of external ID to internal ID could allow
multiple external authentication services to be used to map multiple
externally asserted identities to a single internal user ID. For
example, by extending the application to use Facebook&rsquo;s authentication
service, it would be possible to have both <code>user@gmail.com</code> and
<code>user@facebook.com</code> to be mapped to the same internal user ID, e.g.
<code>:user</code>.</p>
<p>Fundamentally, authenticating and logging in merely associates a user
with a web session. The session is the operative object and identities
are not, and cannot be shared between sessions. A user may have multiple
sessions open, but they don&rsquo;t &ldquo;<em>mingle</em>&quot;.</p>
<h3 id="ad-hoc-_affirmative_-login-method">Ad-hoc <em>affirmative</em> login method</h3>
<p>The application as presented allows a user to simply assert that they
are a known user. The only reason this feature is included is to
simplify debugging. In a production application these assertions would
typically be replaced with an application specific logon process.</p>
<h3 id="isolation-of-sensitive-information-from-codebase">Isolation of sensitive information from codebase</h3>
<p>In order to run Pedestal/Jetty (for production) or Figwheel/Jetty (for
development) with https (required to use Google login) the location of a
keystore and its password must be supplied.</p>
<p>This is an obvious security concern - including any sensitive information in
either the source-code, or the application&rsquo;s generated js code is poor security
hygiene. The application avoids this by using environment variable (assumed to
be available) to store this information which is read-only at runtime.</p>
<h3 id="secured-api-end-points-by-role-membership">Secured API end-points by role membership</h3>
<p>The application uses role-based security, where access to resources (URI&rsquo;s) is
permitted or prohibited according to whether a user has membership within a
particular role. A user ID can be associated with one or more roles. Roles are
independent of one another. There is no concept of hierarchy or inheritance
beyond how the code chooses to handle these concepts.</p>
<p>The application, for our purposes, defines three roles: <code>:admin</code>,
<code>:user</code> and <code>:public</code>. An unauthenticated user is associated with the
role <code>:public</code>. Note that there is nothing privileged about these roles,
or their names. They are completely application defined.</p>
<p>In the code for the application&rsquo;s configuration file
(<code>common-src/config/config.cljc</code>) you can see how these have been
defined:</p>
<pre><code>(def roles-and-users
  {:admin {:roles #{:admin} 
           :users #{&quot;admin@timpsongray.com&quot; &quot;heykieran@gmail.com&quot;}}
   :user {:roles #{:user} 
          :users #{&quot;user@timpsongray.com&quot;}}})
</code></pre>
<p>Here, we&rsquo;ve defined two users <code>:user</code> and <code>:admin</code>, along with two
roles, also called <code>:user</code> and <code>:admin</code>. Users who authenticated with
the email addresses <code>admin@timpsongray.com</code> and <code>heykieran@gmail.com</code>
will be associated with the user ID <code>:admin</code>, and the user with the
email address <code>user@timpsongray.com</code> will be associated with the user ID
<code>:user</code>.</p>
<p>If we examine how routes are defined in the file
<code>server/be_handler_pdstl.clj</code> we can see how security is applied to
URL&rsquo;s.</p>
<pre><code>(def routes
  (route/expand-routes
    #{[&quot;/echo&quot;  :get echo]
      [&quot;/auth/isauthenticated&quot; :post (build-secured-route-vec-to app-auth/get-current-logged-in-user) :route-name :alloc-public/is-authenticated]
      [&quot;/auth/setid&quot; :post (build-secured-route-vec-to app-auth/alloc-auth-explicitly-set-identity-of-user-post) :route-name :alloc-public/auth-set-id-post]
      [&quot;/auth/google&quot; :post (build-secured-route-vec-to app-auth/alloc-auth-google-login) :route-name :alloc-public/google-login-post]
      [&quot;/auth/logout&quot; :post (build-secured-route-vec-to disconnect-session) :route-name :alloc-user/auth-logout-post]
      [&quot;/api/getsecresource/p&quot; :post (build-secured-route-vec-to get-secured-resource) :route-name :alloc-public/test-res]
      [&quot;/api/getsecresource/u&quot; :post (build-secured-route-vec-to get-secured-resource) :route-name :alloc-user/test-res]
      [&quot;/api/getsecresource/a&quot; :post (build-secured-route-vec-to get-secured-resource) :route-name :test-res]
      [&quot;/r/home&quot; :get [content-neg-intc respond-with-app-page] :route-name :app-main-page]}))

</code></pre>
<p>The current implementation uses the namespace of values
of each route&rsquo;s <code>:route-name</code> key to assign security.</p>
<p>Any protected URL whose <code>:route-name</code> namespace is <code>:alloc-public</code> is
available to any user, authenticated or not.</p>
<p>Any protected URL whose <code>:route-name</code> namespace is <code>:alloc-user</code> is
available to any user associated with the <code>:user</code> role.</p>
<p>Any protected URL whose <code>:route-name</code> namespace is <strong>either</strong>
<code>:alloc-admin</code> or the default namespace is available to only users
associated with the <code>:admin</code> role.</p>
<blockquote>
<p>URL&rsquo;s are only <em>protected</em> if they use the auth interceptors. These
interceptors are included when the function
<code>build-secured-route-vec-to</code> is used to wrap the content handler
function.</p>
</blockquote>
<p>Another item to note is the three test URL&rsquo;s <code>/api/getsecresource/p</code>
(available to all users), <code>/api/getsecresource/u</code> (available to users in
the <code>:user</code> role) and <code>/api/getsecresource/a</code> (available only to users
in the <code>:admin</code> role) use the same handler <code>get-secured-resource</code>.</p>
<h3 id="development-server--production-server">Development Server &amp; Production Server</h3>
<p>The application has both a <em>development</em> mode and a <em>production</em> mode. Both
modes use Pedestal as the API server, responding to requests as defined
in the <code>routes</code> parameter used to start the server. The difference
between the two modes is in how the js files are served, and in how
front-end development proceeds, or not.</p>
<p>In <em>development</em> mode the application&rsquo;s js files are served from a handler
(<code>fe-src/server/fe-handler</code>) sitting behind figwheel/Jetty, and started
using the script provided in <code>scripts/server.clj</code>. This facilitates the
<em>standard</em> figwheel development process of having figwheel monitor a set
of source directories and regenerate and reload any changed files as
necessary. This should be familiar to anyone who&rsquo;s used figwheel-main
for ClojureScript development. An alias has been defined in the
<code>deps.edn</code> file to start all the various servers and to start figwheel.</p>
<p>In <em>production</em> mode, the js files are served from the Pedestal/Jetty
server itself. Of course, in order to do this the js files must have
been previously compiled by figwheel. An alias has been defined in the
<code>deps.edn</code> file for this purpose.</p>
<h3 id="log-out-functionality">Log-out Functionality</h3>
<p>The application allows the user to disassociate their session from their
identity. Because the session is the operative object, this is
essentially logging out.</p>
<h3 id="session-expiration">Session Expiration</h3>
<p>When credentials are issued for an authenticated user and associated
with a session, the information will also contain an expiration date. If
a user attempts to access a protected resource and the credentials are
found to have expired, access is denied and the user&rsquo;s credentials are
disassociated from the session. This essentially logs that user out and
he/she will need to reassociate their credentials with the session.</p>
<h3 id="reactreagentreframekee-frame-application">React/Reagent/Reframe/kee-frame Application</h3>
<p>The test application is a reactive application written in ClojureScript
using reagent, reframe and kee-frame. It illustrates some of the
principles required for a simple application of this type.</p>
<h3 id="semantic-ui-integration">Semantic UI Integration</h3>
<p>The toolkit used for widgets and styling is 
<a href="https://react.semantic-ui.com/" target="_blank" rel="noopener">SemanticUI-react</a>, and the
application illustrates how the library can be used.</p>
<h1 id="running-the-servers--applications">Running the Servers &amp; Applications</h1>
<h3 id="setting-up-a-keystore-for-https">Setting up a keystore for HTTPS</h3>
<p>In order to run the web servers in secured mode you&rsquo;ll need to create a
keystore for the certificates used by the servers and make it available
to Jetty. Instructions on how to do this can be found

<a href="https://heykieran.github.io/post/pedestal-jetty-https/" target="_blank" rel="noopener">here</a>.</p>
<h3 id="setting-up-google-login">Setting up Google Login</h3>
<p>In order to use the application for yourself you will need to get your
own Google Client ID. Instructions on how to do this can be found

<a href="https://developers.google.com/identity/sign-in/web/sign-in" target="_blank" rel="noopener">here</a>.</p>
<p>You will also need to use the Google Console to inform Google of the
<strong>Authorized Javascript Origins</strong> associated with your Client ID. These
should be the names and ports of your https endpoints. For testing,
these will typically be the server name and port of your Pedestal/Jetty
and your figwheel/Jetty (for development mode only) servers.</p>
<p>The values should also be set in the following places</p>
<p>In your environment the following variables should be set</p>
<table>
<thead>
<tr>
<th>Environment Variable</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ALLOC_KEYSTORE_PASSWORD</code></td>
<td>The keystore&rsquo;s password</td>
</tr>
<tr>
<td><code>ALLOC_KEYSTORE_LOCATION</code></td>
<td>The keystore&rsquo;s filesystem location</td>
</tr>
<tr>
<td><code>ALLOC_SSL_PORT</code></td>
<td>The ssl port number used for Pedestal</td>
</tr>
<tr>
<td><code>ALLOC_PORT</code></td>
<td>The port number used for Pedestal</td>
</tr>
</tbody>
</table>
<p>In the <code>common-src/config/config.cljc</code> you will need to set the following
variables</p>
<table>
<thead>
<tr>
<th>Configuration Variable</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>google-client-id</code></td>
<td>your Google Client ID</td>
</tr>
<tr>
<td><code>my-hostname</code></td>
<td>your server&rsquo;s name</td>
</tr>
<tr>
<td><code>figwheel-ssl-port</code></td>
<td>the port used by figwheel&rsquo;s https server and serving the application&rsquo;s js files</td>
</tr>
<tr>
<td><code>pedestal-port</code></td>
<td>Pedestal&rsquo;s HTTP port number (should match <code>ALLOC_PORT</code>).</td>
</tr>
<tr>
<td><code>pedestal-ssl-port</code></td>
<td>Pedestal&rsquo;s HTTPS port number (should match <code>ALLOC_SSL_PORT</code>)</td>
</tr>
<tr>
<td><code>google-callback-url</code></td>
<td>change the server name in this variable to match your server&rsquo;s name.</td>
</tr>
</tbody>
</table>
<p>In the file <code>dev.cljs.edn</code> change the <code>:open-url</code> parameter to match your
server&rsquo;s name, and the ssl port used by figwheel. This should match
<code>https://&lt;my-hostname&gt;:&lt;pedestal-ssl-port&gt;/r/home</code>.</p>
<h3 id="starting-the-servers">Starting the Server(s)</h3>
<h4 id="development-mode">Development Mode</h4>
<ol>
<li>
<p>In your IDE of choice, start a REPL (with the alias <code>:main</code>)</p>
</li>
<li>
<p>Load and execute the <code>control</code> namespace</p>
</li>
<li>
<p>Execute the function <code>(start-dev)</code> (It&rsquo;s within a <code>comment</code> expression).</p>
</li>
<li>
<p>Log messages are sent to the REPL output stream, so you can monitor
progress and activity.</p>
</li>
<li>
<p>When the Pedestal server has started, run the following from a command line</p>
<pre><code>clj -A:dev
</code></pre>
<p>This will start the front-end server used by figwheel on ports 9500 and
<code>figwheel-ssl-port</code> and will start the figwheel watch process.</p>
</li>
<li>
<p>Your browser should automatically open to
<code>https://&lt;my-hostname&gt;:&lt;figwheel-ssl-port&gt;/r/home</code> where the application
will be loaded. (You should have set this in <code>dev.cljs.edn</code> as above).</p>
</li>
</ol>
<div class="alert alert-note">
  <div>
    When you&rsquo;re finished and wish to stop the front-end server: from the Figwheel console you issue the <code>:cljs/quit</code> command to stop the Figwheel build process followed by Ctrl+C to stop the front-end server itself.
  </div>
</div>
<h4 id="production-mode">Production Mode</h4>
<p>Build the production application by running</p>
<pre><code>clj -A:prod
</code></pre>
<p>from the command line. This will generate the production js files from your ClojureScript sources. Then, from the command line run</p>
<pre><code>clj -A:main:main-output -m control
</code></pre>
<p>This will start the Pedestal server which in addition to serving API requests will also serve the js files built in the last step.</p>
<p>Finally, open your browser and navigate to <code>https://&lt;my-hostname&gt;:8081/r/home</code> to display the application&rsquo;s Home page.</p>
<h2 id="navigating-the-application">Navigating the Application</h2>
<h3 id="the-home-page">The Home Page</h3>
<p>When the application first starts, you can go to the Home page</p>





  
  











<figure id="figure-the-initial-view-of-the-home-page-no-logged-in-user">


  <a data-fancybox="" href="/post/pedestal-and-google/static/img/home-page_huaaba3d4bf3897864ad8c0dbe2950fa00_42345_2000x2000_fit_lanczos_2.png" data-caption="The initial view of the home page (&lt;strong&gt;no&lt;/strong&gt; logged-in user).">


  <img data-src="/post/pedestal-and-google/static/img/home-page_huaaba3d4bf3897864ad8c0dbe2950fa00_42345_2000x2000_fit_lanczos_2.png" class="lazyload" alt="" width="1338" height="352">
</a>


  
  
  <figcaption>
    The initial view of the home page (<strong>no</strong> logged-in user).
  </figcaption>


</figure>

<h3 id="the-applications-menu">The Application&rsquo;s Menu</h3>
<p>The application is a SPA with client-side routing and has only a single menu with 5 menu items.</p>





  
  











<figure id="figure-the-main-menu-no-logged-in-user">


  <a data-fancybox="" href="/post/pedestal-and-google/static/img/home-page-menu-no-logged-in-user_hufd402a6ba5fecc72c633474ae2fa3e3d_57047_2000x2000_fit_lanczos_2.png" data-caption="The main menu (&lt;strong&gt;no&lt;/strong&gt; logged-in user).">


  <img data-src="/post/pedestal-and-google/static/img/home-page-menu-no-logged-in-user_hufd402a6ba5fecc72c633474ae2fa3e3d_57047_2000x2000_fit_lanczos_2.png" class="lazyload" alt="" width="1338" height="674">
</a>


  
  
  <figcaption>
    The main menu (<strong>no</strong> logged-in user).
  </figcaption>


</figure>

<ol>
<li>The <strong>Home</strong> item will take you to the Home page</li>
<li>The <strong>Users</strong> menu item will display the application&rsquo;s Sign-In/Sign-Out page. Here you can connect an identity to your session (<em>log-in</em>), or disconnect an identity from your session (<em>log-out</em>).</li>
<li>The <strong>Public</strong> menu item will request content from an unsecured API endpoint whose content is available to any user whether authenticated or not.</li>
<li>The <strong>User</strong> menu item will request content from an an API endpoint to which access has been restricted to users with <strong>role</strong> memberships of <code>:admin</code> or <code>:user</code>.</li>
<li>The <strong>Admin</strong> menu item will request content from an an API endpoint to which access has been restricted to users with <strong>role</strong> membership of <code>:admin</code>.</li>
</ol>
<h3 id="access-a-public-resource">Access a Public Resource</h3>
<p>Even though you have not yet signed in, if you click on the <strong>Public</strong> menu item the application will respond with some content.</p>





  
  











<figure id="figure-access-to-public-resource-is-allowed-no-logged-in-user">


  <a data-fancybox="" href="/post/pedestal-and-google/static/img/access-public-resource_huf6a3c9ebea043d4f5d4e6b23eba4a1b4_41499_2000x2000_fit_lanczos_2.png" data-caption="Access to Public Resource is allowed (&lt;strong&gt;no&lt;/strong&gt; logged-in user).">


  <img data-src="/post/pedestal-and-google/static/img/access-public-resource_huf6a3c9ebea043d4f5d4e6b23eba4a1b4_41499_2000x2000_fit_lanczos_2.png" class="lazyload" alt="" width="1340" height="418">
</a>


  
  
  <figcaption>
    Access to Public Resource is allowed (<strong>no</strong> logged-in user).
  </figcaption>


</figure>

<p>This is as expected as that resource is unsecured and available to anyone who can access the application.</p>
<h3 id="sign-in-as-the-localuser-user">Sign-In as the <code>:local/:user</code> User</h3>
<p>On the Sign-In Page, click on the button labelled <strong><a href="mailto:user@timpsongray.com">user@timpsongray.com</a></strong>. This will associate you session with the application user <code>:user</code>, who has been assigned the <code>:user</code> <strong>role</strong>. This form of sign-in is a <code>:local</code> authority sign-in. The authority is granted by the application itself.</p>





  
  











<figure id="figure-the-standard-sign-in-page-no-logged-in-user">


  <a data-fancybox="" href="/post/pedestal-and-google/static/img/sign-in-page_hu08d58e743afadb57a341d72a72bfa387_91827_2000x2000_fit_lanczos_2.png" data-caption="The Standard Sign-In Page (&lt;strong&gt;no&lt;/strong&gt; logged-in user).">


  <img data-src="/post/pedestal-and-google/static/img/sign-in-page_hu08d58e743afadb57a341d72a72bfa387_91827_2000x2000_fit_lanczos_2.png" class="lazyload" alt="" width="1336" height="868">
</a>


  
  
  <figcaption>
    The Standard Sign-In Page (<strong>no</strong> logged-in user).
  </figcaption>


</figure>

<p>Once you&rsquo;ve done that you&rsquo;ll be redirected to the <strong>Home</strong> page where your session and identity details are displayed.</p>





  
  











<figure id="figure-after-the-user-user-has-signed-in">


  <a data-fancybox="" href="/post/pedestal-and-google/static/img/user-user-signed-in_hu88471979aee3312eae8537ac4b138fbe_46032_2000x2000_fit_lanczos_2.png" data-caption="After the user &lt;code&gt;:user&lt;/code&gt; has signed in.">


  <img data-src="/post/pedestal-and-google/static/img/user-user-signed-in_hu88471979aee3312eae8537ac4b138fbe_46032_2000x2000_fit_lanczos_2.png" class="lazyload" alt="" width="1340" height="372">
</a>


  
  
  <figcaption>
    After the user <code>:user</code> has signed in.
  </figcaption>


</figure>

<h3 id="accessing-a-protected-resource">Accessing a protected resource</h3>
<p>Now click on the <strong>User</strong> menu item. The application will attempt to fetch a resource from an API endpoint restricted to users in the <code>:user</code> or <code>:admin</code> roles.</p>
<p>Because <code>:user</code> has that role association the contents of the resource is displayed.</p>





  
  











<figure id="figure-the-user-user-is-allowed-to-access-to-the-user-resource">


  <a data-fancybox="" href="/post/pedestal-and-google/static/img/user-accesses-user-page-ok_hua77f555305a4e482c429b34566c4f1b6_45163_2000x2000_fit_lanczos_2.png" data-caption="The user (&lt;code&gt;:user&lt;/code&gt;) is allowed to access to the &lt;strong&gt;User&lt;/strong&gt; resource.">


  <img data-src="/post/pedestal-and-google/static/img/user-accesses-user-page-ok_hua77f555305a4e482c429b34566c4f1b6_45163_2000x2000_fit_lanczos_2.png" class="lazyload" alt="" width="1344" height="426">
</a>


  
  
  <figcaption>
    The user (<code>:user</code>) is allowed to access to the <strong>User</strong> resource.
  </figcaption>


</figure>

<p>However, if you now click on the <strong>Admin</strong> menu item, which attempts to fetch
data from an API endpoint restricted to <code>:admin</code> role members only, you&rsquo;ll see
an access denied message.</p>





  
  











<figure id="figure-the-user-user-is-denied-access-to-the-admin-resource">


  <a data-fancybox="" href="/post/pedestal-and-google/static/img/user-accesses-admin-page-denied_hu8fda4bc3b88839b1d49961b5d15e137b_125581_2000x2000_fit_lanczos_2.png" data-caption="The user (&lt;code&gt;:user&lt;/code&gt;) is denied access to the &lt;strong&gt;Admin&lt;/strong&gt; resource.">


  <img data-src="/post/pedestal-and-google/static/img/user-accesses-admin-page-denied_hu8fda4bc3b88839b1d49961b5d15e137b_125581_2000x2000_fit_lanczos_2.png" class="lazyload" alt="" width="1334" height="592">
</a>


  
  
  <figcaption>
    The user (<code>:user</code>) is denied access to the <strong>Admin</strong> resource.
  </figcaption>


</figure>

<h3 id="sign-out-from-user">Sign-Out from <code>:user</code></h3>
<p>Click on the <strong>Users</strong> menu item to go to the Sign-In/Sign-Out page</p>





  
  











<figure id="figure-a-view-of-the-standard-sign-out-page-with-user-user-is-logged-in">


  <a data-fancybox="" href="/post/pedestal-and-google/static/img/local-user-sign-out_hu5288488acb08e3af3122c648af377573_121592_2000x2000_fit_lanczos_2.png" data-caption="A view of the standard Sign-Out page with user (&lt;code&gt;:user&lt;/code&gt;) is logged in.">


  <img data-src="/post/pedestal-and-google/static/img/local-user-sign-out_hu5288488acb08e3af3122c648af377573_121592_2000x2000_fit_lanczos_2.png" class="lazyload" alt="" width="1334" height="1170">
</a>


  
  
  <figcaption>
    A view of the standard Sign-Out page with user (<code>:user</code>) is logged in.
  </figcaption>


</figure>

<p>and at the bottom click on the button in <strong>Sign-Out (Local)</strong> section. This will remove the identity information from your session, and return you to the Home page.</p>





  
  











<figure id="figure-returned-to-home-page-after-user-signs-out">


  <a data-fancybox="" href="/post/pedestal-and-google/static/img/home-page_huaaba3d4bf3897864ad8c0dbe2950fa00_42345_2000x2000_fit_lanczos_2.png" data-caption="Returned to Home Page after user signs out.">


  <img data-src="/post/pedestal-and-google/static/img/home-page_huaaba3d4bf3897864ad8c0dbe2950fa00_42345_2000x2000_fit_lanczos_2.png" class="lazyload" alt="" width="1338" height="352">
</a>


  
  
  <figcaption>
    Returned to Home Page after user signs out.
  </figcaption>


</figure>

<h3 id="sign-in-as-a-google-user">Sign in as a Google User</h3>
<p>Again, click on the <strong>Users</strong> menu item to go to the Sign-In/Sign-Out page</p>





  
  











<figure id="figure-the-standard-sign-in-page">


  <a data-fancybox="" href="/post/pedestal-and-google/static/img/sign-in-page_hu08d58e743afadb57a341d72a72bfa387_91827_2000x2000_fit_lanczos_2.png" data-caption="The Standard Sign-In Page.">


  <img data-src="/post/pedestal-and-google/static/img/sign-in-page_hu08d58e743afadb57a341d72a72bfa387_91827_2000x2000_fit_lanczos_2.png" class="lazyload" alt="" width="1336" height="868">
</a>


  
  
  <figcaption>
    The Standard Sign-In Page.
  </figcaption>


</figure>

<p>This time however click on the Google <strong>Sign in</strong> button. This will open the familiar Google Sign-In dialog where you can login with your Google identity. If the email address of the Google user is registered with an application user ID your session will assigned that identity, but the <code>:authority</code> will now be <code>:google</code>, indicating that is the entity making the assertion of identity.</p>





  
  











<figure id="figure-the-google-sign-in-dialog">


  <a data-fancybox="" href="/post/pedestal-and-google/static/img/google-login-dialog_hu00c65657a65268155e33b18fe1910fb9_72909_2000x2000_fit_lanczos_2.png" data-caption="The Google Sign-In Dialog.">


  <img data-src="/post/pedestal-and-google/static/img/google-login-dialog_hu00c65657a65268155e33b18fe1910fb9_72909_2000x2000_fit_lanczos_2.png" class="lazyload" alt="" width="1178" height="712">
</a>


  
  
  <figcaption>
    The Google Sign-In Dialog.
  </figcaption>


</figure>

<p>Again, you&rsquo;ll be returned to the Home page where the session&rsquo;s identity information is displayed.</p>





  
  











<figure id="figure-the-home-page-with-google-signed-in-user">


  <a data-fancybox="" href="/post/pedestal-and-google/static/img/google-user-login-home_hu0f008ac669061a5310176bfbdabf1530_48835_2000x2000_fit_lanczos_2.png" data-caption="The Home Page with Google signed-in user.">


  <img data-src="/post/pedestal-and-google/static/img/google-user-login-home_hu0f008ac669061a5310176bfbdabf1530_48835_2000x2000_fit_lanczos_2.png" class="lazyload" alt="" width="1478" height="352">
</a>


  
  
  <figcaption>
    The Home Page with Google signed-in user.
  </figcaption>


</figure>

<p>Because <strong><a href="mailto:heykieran@gmail.com">heykieran@gmail.com</a></strong> is an alias for the user <code>:admin</code>, that is the ID displayed in the top-right corner of the page, and consequently access to the API endpoints restricted to users in the <code>:admin</code> role will be allowed.</p>
<h3 id="signing-out">Signing Out</h3>
<p>If you click on the <strong>Users</strong> menu item you can return to the Sign-In/Sign-Out page to disconnect your session from the Google account using the <strong>Sign Out</strong> button. This disconnects your application session, but does <strong>not</strong> log you out from Google.</p>





  
  











<figure id="figure-the-users-page-with-a-signed-in-google-user-mapped-to-application-id-admin">


  <a data-fancybox="" href="/post/pedestal-and-google/static/img/google-user-sign-out-page_hua45813ca70e13bb9a469ee5545a5e2d9_106661_2000x2000_fit_lanczos_2.png" data-caption="The Users page with a Signed-In Google user (mapped to application ID &lt;code&gt;:admin&lt;/code&gt;).">


  <img data-src="/post/pedestal-and-google/static/img/google-user-sign-out-page_hua45813ca70e13bb9a469ee5545a5e2d9_106661_2000x2000_fit_lanczos_2.png" class="lazyload" alt="" width="1340" height="908">
</a>


  
  
  <figcaption>
    The Users page with a Signed-In Google user (mapped to application ID <code>:admin</code>).
  </figcaption>


</figure>


    </div>

    





  
  

<p class="edit-page">
  <a href="https://github.com/heykieran/timpson-gray-blog/edit/master/content/post/pedestal-and-google/index.md">
    <i class="fas fa-pen pr-2"></i>Edit this page
  </a>
</p>





<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/clojure/">clojure</a>
  
  <a class="badge badge-light" href="/tag/clojurescript/">clojurescript</a>
  
  <a class="badge badge-light" href="/tag/pedestal/">pedestal</a>
  
  <a class="badge badge-light" href="/tag/security/">security</a>
  
  <a class="badge badge-light" href="/tag/react/">react</a>
  
</div>














  
    
    





  
    
    
    
      
    
    
    
    <div class="media author-card content-widget-hr">
      
        
        <img class="avatar mr-3 avatar-circle" src="/author/kieran-owens/avatar_hu52a603635ecebd45650b162dadabb4e5_12861_270x270_fill_q90_lanczos_center.jpg" alt="Kieran Owens">
      

      <div class="media-body">
        <h5 class="card-title"><a href="https://heykieran.github.io/">Kieran Owens</a></h5>
        <h6 class="card-subtitle">CTO of Timpson Gray</h6>
        <p class="card-text">Experienced Technology Leader with a particular interest in the use of functional languages for building accounting systems.</p>
        <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/heykieran" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/heykieran" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
</ul>

      </div>
    </div>
  


  





<section id="comments">
  
    
<div id="disqus_thread"></div>
<script>
  let disqus_config = function () {
    
    
    
  };
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
      return;
    }
    var d = document, s = d.createElement('script'); s.async = true;
    s.src = 'https://' + "heykieran" + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  
</section>






  
  
  <div class="article-widget content-widget-hr">
    <h3>Related</h3>
    <ul>
      
      <li><a href="/post/pedestal-jetty-https/">Setting-up Pedestal/Jetty with HTTPS</a></li>
      
      <li><a href="/post/cadence-and-clojure/">Cadence Workflow and Clojure</a></li>
      
    </ul>
  </div>
  




  </div>
</article>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/clojure.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/shell.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/bash.min.js"></script>
        
      

    

    
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    <script>const isSiteThemeDark = false;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks",
        'slides' : "Slides"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    
    <script id="dsq-count-scr" src="https://heykieran.disqus.com/count.js" async></script>
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.37431be2d92d7fb0160054761ab79602.js"></script>

    






  
  
  <div class="container">
    <footer class="site-footer">
  

  <p class="powered-by">
    © Kieran J. Owens 2020
  </p>

  
  






  <p class="powered-by">
    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
