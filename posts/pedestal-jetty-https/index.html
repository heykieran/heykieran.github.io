<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Kieran Owens">
    <meta name="description" content="Kieran Owens&#39; development blog">
    <meta name="keywords" content="blog,developer,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Setting-up Pedestal/Jetty with HTTPS"/>
<meta name="twitter:description" content="Introduction
Setting up Pedestal (using Jetty) with HTTPS isn&#39;t that difficult, but it is a bit &ldquo;fiddly&rdquo;. Essentially, you&#39;ll need a keystore so that Jetty has access to encryption keys and can encrypt pages sent over HTTPS.
This post only deals with self-signed certificates, but if you want to use commercially-signed certificates it should work too. Just be aware that Jetty is happiest with pkcs12 formats - I&#39;ve never got it to work satisfactorily using other formats."/>

    <meta property="og:title" content="Setting-up Pedestal/Jetty with HTTPS" />
<meta property="og:description" content="Introduction
Setting up Pedestal (using Jetty) with HTTPS isn&#39;t that difficult, but it is a bit &ldquo;fiddly&rdquo;. Essentially, you&#39;ll need a keystore so that Jetty has access to encryption keys and can encrypt pages sent over HTTPS.
This post only deals with self-signed certificates, but if you want to use commercially-signed certificates it should work too. Just be aware that Jetty is happiest with pkcs12 formats - I&#39;ve never got it to work satisfactorily using other formats." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://heykieran.github.io/posts/pedestal-jetty-https/" />
<meta property="article:published_time" content="2020-04-17T13:39:37-04:00" />
<meta property="article:modified_time" content="2020-04-17T13:39:37-04:00" />


    
      <base href="https://heykieran.github.io/posts/pedestal-jetty-https/">
    
    <title>
  Setting-up Pedestal/Jetty with HTTPS · heykieran code notes
</title>

    
      <link rel="canonical" href="https://heykieran.github.io/posts/pedestal-jetty-https/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css" integrity="sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://heykieran.github.io/css/coder.min.a4f332213a21ce8eb521670c614470c58923aaaf385e2a73982c31dd7642decb.css" integrity="sha256-pPMyITohzo61IWcMYURwxYkjqq84XipzmCwx3XZC3ss=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="https://heykieran.github.io/css/custom.css" />
    

    

    

    <link rel="icon" type="image/png" href="https://heykieran.github.io/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://heykieran.github.io/img/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.62.1" />
  </head>

  
  
  <body class="colorscheme-light">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://heykieran.github.io/">
      heykieran code notes
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://heykieran.github.io/posts/">Posts &amp; Notes</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://heykieran.github.io/blog/">Blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://heykieran.github.io/about/">About</a>
          </li>
        
      
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Setting-up Pedestal/Jetty with HTTPS</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2020-04-17T13:39:37-04:00'>
                April 17, 2020
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              
            </span>
          </div>
          
          
        </div>
      </header>

      <div>
        
        <p><strong>Introduction</strong></p>
<p>Setting up Pedestal (using Jetty) with HTTPS isn't that difficult, but
it is a bit &ldquo;fiddly&rdquo;. Essentially, you'll need a keystore so that Jetty has
access to encryption keys and can encrypt pages sent over HTTPS.</p>
<p><em>This post only deals with self-signed certificates, but if you want to use
commercially-signed certificates it should work too. Just be aware that
Jetty is happiest with pkcs12 formats - I've never got it to work satisfactorily
using other formats.</em></p>
<p><strong>Service Map (Pedestal)</strong></p>
<p>In order to run Jetty under Pedestal you'll need to supply a service map. The following service map works for me. You can change it as you need. The important elements in the
current context are where Jetty should look for the keystore (<code>keystore-location</code>),
the <code>:ssl?</code> key, the <code>:ssl-port</code> and the <code>:security-provider</code>.</p>
<p><em>Make sure the provider (Conscrypt) is in your <code>deps.edn</code> file</em></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">
(def service-map
  (let
    [keystore-location
     (if (System/getenv &#34;KEYSTORE_LOCATION&#34;)
       (-&gt; (io/file (System/getenv &#34;KEYSTORE_LOCATION&#34;))
           (.getCanonicalPath))
       &#34;/home/user/security/jetty-keystore&#34;)]
    {::http/host &#34;0.0.0.0&#34;
     ::http/allowed-origins
                 {:allowed-origins (fn[_] true)
                  :creds true}
     ::http/routes #(deref #&#39;routes)
     ::http/type   :jetty
     ::http/container-options
     {:context-configurator jetty-websocket-configurator
      :h2c? true
      :h2 true
      :ssl? true
      :ssl-port 8081
      :keystore keystore-location
      :key-password &#34;thepassword&#34;
      :security-provider &#34;Conscrypt&#34;}
     ::http/port 8080}))
</code></pre></div><p><strong>Jetty Keystore</strong></p>
<p>In order for Pedestal to start with Jetty,
it expects to find a keystore in a particular location
(see <em>Service Map</em> notes above).</p>
<p>To create the keystore (I've plagiarized/assembled from the following
pieces of information web, and I'm afraid I can't remember the source(s).)</p>
<p>Generate a private site key (<code>site.key</code>)</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ openssl genrsa -des3 -out site.key 2048
</code></pre></div><p>Make a copy of <code>site.key</code> and strip the password, so that it can be auto-loaded</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ cp site.key site.orig.key
$ openssl rsa -in site.orig.key -out site.key
</code></pre></div><p>Generate a self-signed signing request (<code>site.csr</code>)</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ openssl req -new -key site.key -out site.csr
</code></pre></div><p>Generate a self-signed certificate (<code>sitex509.crt</code> - in <strong>x509</strong> format for loading into the keystore)</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ openssl req -new -x509 -key site.key -out sitex509.crt
</code></pre></div><p>Combine the self-signed certificate (<code>sitex509.crt</code>) and site key (<code>site.key</code>) and
export it in <strong>pkcs12</strong> format (<code>site.pkcs12</code>)</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ openssl pkcs12 -inkey site.key -in sitex509.crt -export -out site.pkcs12
</code></pre></div><p>Rename the keystore (<code>site.pkcs12</code>) to jetty-keystore</p>
<p>and adjust the service-map to use it</p>

      </div>


      <footer>
        


        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "heykieran" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        
        
      </footer>
    </article>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  </section>

      </div>

      
  <footer class="footer">
    <section class="container">
      
        <p>KJO</p>
      
      
        ©
        
        2020
         Kieran Owens 
      
      
         · 
         <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
      
      
    </section>
  </footer>

    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-153619296-3', 'auto');
	
	ga('send', 'pageview');
}
</script>


    

  </body>

</html>
